name: Build, Test and Publish

on:
  push:
    branches:
      - main
    tags:
      - 'v*'   # e.g. v1.2.3

concurrency:
  group: ${{ github.workflow }}-${{ github.sha }}
  cancel-in-progress: ${{ github.ref_type == 'tag' }}

jobs:
  build-and-test:
    name: Build, Test and Analyze
    runs-on: ubuntu-latest
    if: |
      github.ref_type == 'tag' || 
      (github.ref_name == 'main' && !startsWith(github.ref, 'refs/tags/'))
    env:
      CSPROJ_PATH: dotnet/src/xjustiz.core-dotnet/xjustiz.core-dotnet.csproj
      TEST_PROJECT_PATH: dotnet/src/xjustiz.core-dotnet.UnitTests/xjustiz.core-dotnet.UnitTests.csproj
    permissions:
      actions: write  # This is the required permission for 'gh run cancel'
      contents: write # Required to checkout code/read tags
    steps:
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'zulu'

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Skip branch run if tag exists
        if: github.ref_type == 'branch' && github.ref_name == 'main'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Wait a few seconds to ensure tag is registered in the local git environment after checkout
          sleep 2
          # Check if any tag starting with 'v' points to the current commit
          TAG=$(git tag --points-at HEAD | grep "^v" | head -n 1)
          if [ -n "$TAG" ]; then
            echo "A version tag ($TAG) exists for this commit. Cancelling redundant branch run."
            gh run cancel ${{ github.run_id }}
            # Wait for cancellation to take effect
            sleep 10
          fi

      - name: Cache SonarQube Cloud packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Cache SonarQube Cloud scanner
        id: cache-sonar-scanner
        uses: actions/cache@v4
        with:
          path: ./.sonar/scanner
          key: ${{ runner.os }}-sonar-scanner
          restore-keys: ${{ runner.os }}-sonar-scanner

      - name: Install SonarQube Cloud scanner
        if: steps.cache-sonar-scanner.outputs.cache-hit != 'true'
        run: |
          mkdir -p ./.sonar/scanner
          dotnet tool update dotnet-sonarscanner --tool-path ./.sonar/scanner

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore
        run: dotnet restore $CSPROJ_PATH

      - name: Build and analyze
        env:
          GITHUB_TOKEN: ${{ secrets.GIT_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          ./.sonar/scanner/dotnet-sonarscanner begin /k:"l-pagel_X.Justiz.Core" /o:"l-pagel" /d:sonar.token="${{ secrets.SONAR_TOKEN }}" /d:sonar.host.url="https://sonarcloud.io" /d:sonar.exclusions="X.Justiz-Versions/**/*,scripts/**/*" /d:sonar.cpd.exclusions="**/StaatCodeLists.cs,**/GerichtCodeLists.cs,**/DokumentklasseCodeLists.cs" /d:sonar.branch.name="main" /d:sonar.cs.vstest.reportsPaths="**/*.trx" /d:sonar.cs.opencover.reportsPaths="**/coverage.opencover.xml"
          dotnet build $CSPROJ_PATH
          dotnet test $TEST_PROJECT_PATH --logger trx --collect:"XPlat Code Coverage" -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover
          ./.sonar/scanner/dotnet-sonarscanner end /d:sonar.token="${{ secrets.SONAR_TOKEN }}"


  verify-documentation:
    name: Verify Data Model Documentation
    needs: [build-and-test]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Run verification script
        run: python scripts/verify_documentation.py

  generate-xsd:
    name: Generate and Push XSDs
    needs: [build-and-test]
    runs-on: ubuntu-latest
    permissions:
      actions: write  # This is the required permission for 'gh run cancel'
      contents: write # Required to checkout code/read tags
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Generate XSDs
        run: dotnet run --project dotnet/src/xjustiz.core-dotnet.XsdGenerator/xjustiz.core-dotnet.XsdGenerator.csproj -- "${{ github.workspace }}"

      - name: Commit and Push generated XSDs
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add -f X.Justiz-Core-Versions
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update generated XSDs [skip ci]"
            if [[ "${{ github.ref_type }}" == "tag" ]]; then
              echo "Pushing to main since we are on a tag"
              git push origin HEAD:main
            else
              git push origin HEAD:${{ github.ref_name }}
            fi
          fi

  publish:
    name: Version and Publish
    needs: [build-and-test, generate-xsd, verify-documentation]
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    env:
      CSPROJ_PATH: dotnet/src/xjustiz.core-dotnet/xjustiz.core-dotnet.csproj

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Get version from tag
        id: get_version
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Update csproj version
        run: |
          VERSION='${{ steps.get_version.outputs.version }}'
          CSProj="$CSPROJ_PATH"

          echo "Setting <Version>$VERSION</Version> in $CSProj"

          # Replace the <Version>...</Version> in PropertyGroup:
          sed -i "s#<Version>.*</Version>#<Version>$VERSION</Version>#g" "$CSProj"

      - name: Restore
        run: dotnet restore $CSPROJ_PATH

      - name: Build Release
        run: dotnet build $CSPROJ_PATH --configuration Release --no-restore

      - name: Pack
        run: dotnet pack $CSPROJ_PATH --configuration Release --no-build -o ./artifacts

      - name: Push to NuGet
        run: >
          dotnet nuget push "./artifacts/*.nupkg"
          --api-key ${{ secrets.NUGET_API_KEY }}
          --source https://api.nuget.org/v3/index.json
          --skip-duplicate
