name: Build, Test and Publish

on:
  push:
    branches:
      - main
    tags:
      - 'v*'   # e.g. v1.2.3
  pull_request:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-test:
    name: Build, Test and Analyze
    runs-on: ubuntu-latest
    env:
      CSPROJ_PATH: dotnet/src/xjustiz.core-dotnet/xjustiz.core-dotnet.csproj
      TEST_PROJECT_PATH: dotnet/src/xjustiz.core-dotnet.UnitTests/xjustiz.core-dotnet.UnitTests.csproj
    permissions:
      actions: write  # This is the required permission for 'gh run cancel'
      contents: write # Required to checkout code/read tags
    steps:
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'zulu'

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Skip branch run if tag exists
        if: github.event_name == 'push' && github.ref_type == 'branch' && github.ref_name == 'main'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Wait a few seconds to ensure tag is registered in the local git environment after checkout
          sleep 2
          # Check if any tag starting with 'v' points to the current commit
          TAG=$(git tag --points-at HEAD | grep "^v" | head -n 1)
          if [ -n "$TAG" ]; then
            echo "A version tag ($TAG) exists for this commit. Cancelling redundant branch run."
            gh run cancel ${{ github.run_id }}
            # Wait for cancellation to take effect
            sleep 10
          fi

      - name: Cache SonarQube Cloud packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Cache SonarQube Cloud scanner
        id: cache-sonar-scanner
        uses: actions/cache@v4
        with:
          path: ./.sonar/scanner
          key: ${{ runner.os }}-sonar-scanner
          restore-keys: ${{ runner.os }}-sonar-scanner

      - name: Install SonarQube Cloud scanner
        if: steps.cache-sonar-scanner.outputs.cache-hit != 'true'
        run: |
          mkdir -p ./.sonar/scanner
          dotnet tool update dotnet-sonarscanner --tool-path ./.sonar/scanner

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore
        run: dotnet restore $CSPROJ_PATH

      - name: Build and analyze
        env:
          GITHUB_TOKEN: ${{ secrets.GIT_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          ./.sonar/scanner/dotnet-sonarscanner begin /k:"l-pagel_X.Justiz.Core" /o:"l-pagel" /d:sonar.token="${{ secrets.SONAR_TOKEN }}" /d:sonar.host.url="https://sonarcloud.io" /d:sonar.exclusions="X.Justiz-Versions/**/*,scripts/**/*" /d:sonar.cpd.exclusions="**/StaatCodeLists.cs,**/GerichtCodeLists.cs,**/DokumentklasseCodeLists.cs" /d:sonar.branch.name="main" /d:sonar.cs.vstest.reportsPaths="**/*.trx" /d:sonar.cs.opencover.reportsPaths="**/coverage.opencover.xml"
          dotnet build $CSPROJ_PATH
          dotnet test $TEST_PROJECT_PATH --logger trx --collect:"XPlat Code Coverage" -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover
          ./.sonar/scanner/dotnet-sonarscanner end /d:sonar.token="${{ secrets.SONAR_TOKEN }}"


  verify-documentation:
    name: Verify Data Model Documentation
    needs: [build-and-test]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Run verification script
        run: python scripts/verify_documentation.py

  generate-xsd:
    name: Generate XSDs
    needs: [build-and-test]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Generate XSDs
        run: dotnet run --project dotnet/src/xjustiz.core-dotnet.XsdGenerator/xjustiz.core-dotnet.XsdGenerator.csproj -- "${{ github.workspace }}"

      - name: Verify XSDs generated successfully
        run: |
          if [ ! -d "X.Justiz-Core-Versions" ] || [ ! -d "schemas" ]; then
            echo "ERROR: XSD generation failed - expected directories not found"
            exit 1
          fi
          echo "XSD generation successful"

      - name: Commit and Push generated XSDs
        if: github.event_name == 'push'
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add -f X.Justiz-Core-Versions schemas
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update generated XSDs and schemas [skip ci]"
            if [[ "${{ github.ref_type }}" == "tag" ]]; then
              echo "Pushing to main since we are on a tag"
              git push origin HEAD:main
            else
              git push origin HEAD:${{ github.ref_name }}
            fi
          fi

  generate-java-sdk:
    name: Generate Java SDK
    needs: [generate-xsd]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Pull latest changes (push events only)
        if: github.event_name == 'push'
        run: git pull origin ${{ github.ref_name }} || true

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Download jsonschema2pojo CLI
        run: |
          curl -L -o jsonschema2pojo.tar.gz https://github.com/joelittlejohn/jsonschema2pojo/releases/download/jsonschema2pojo-1.2.2/jsonschema2pojo-1.2.2.tar.gz
          tar -xzf jsonschema2pojo.tar.gz
          chmod +x jsonschema2pojo-1.2.2/bin/jsonschema2pojo

      - name: Generate Java Models from Schema
        run: |
          ./jsonschema2pojo-1.2.2/bin/jsonschema2pojo \
            --source schemas/xjustiz-core.schema.json \
            --target java/src/main/java \
            --package de.xjustiz.core.models.generated \
            --annotation-style JACKSON2 \
            --jsr303-annotations \
            --datetime-class java.time.OffsetDateTime \
            --use-title-as-classname \
            --useJakartaValidation

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Build and Test Java SDK
        working-directory: java
        run: gradle build test

      - name: Commit Generated Models
        if: github.event_name == 'push'
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add java/
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: regenerate Java models from schema [skip ci]"
            git push origin HEAD:${{ github.ref_name }}
          fi

  verify-cross-sdk-parity:
    name: Verify Cross-SDK Parity
    needs: [generate-java-sdk]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Pull latest changes (push events only)
        if: github.event_name == 'push'
        run: git pull origin ${{ github.ref_name }} || true

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Run .NET Parity Tests
        run: dotnet test dotnet/test/xjustiz.core-dotnet.CrossSdkTests

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Run Java Parity Tests
        working-directory: java
        run: gradle test --tests "*SchemaParityTest*"


  publish:
    name: Version and Publish
    needs: [build-and-test, generate-xsd, verify-documentation, verify-cross-sdk-parity]
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    env:
      CSPROJ_PATH: dotnet/src/xjustiz.core-dotnet/xjustiz.core-dotnet.csproj

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Get version from tag
        id: get_version
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Update csproj version
        run: |
          VERSION='${{ steps.get_version.outputs.version }}'
          CSProj="$CSPROJ_PATH"

          echo "Setting <Version>$VERSION</Version> in $CSProj"

          # Replace the <Version>...</Version> in PropertyGroup:
          sed -i "s#<Version>.*</Version>#<Version>$VERSION</Version>#g" "$CSProj"

      - name: Restore
        run: dotnet restore $CSPROJ_PATH

      - name: Build Release
        run: dotnet build $CSPROJ_PATH --configuration Release --no-restore

      - name: Pack
        run: dotnet pack $CSPROJ_PATH --configuration Release --no-build -o ./artifacts

      - name: Push to NuGet
        run: >
          dotnet nuget push "./artifacts/*.nupkg"
          --api-key ${{ secrets.NUGET_API_KEY }}
          --source https://api.nuget.org/v3/index.json
          --skip-duplicate
